<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>2048 — Lab</title>
  <style>
        :root{
      --bg:#f2efe9; --tile-bg:#cdc1b4; --accent:#7F3FF2;
      --board-size: min(480px, 90vmin);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
              *{box-sizing:border-box}
    body{margin:0;display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(180deg,#fafafa,#eee);color:#222}
    .app{width:100%;max-width:980px;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    h1{font-size:20px;margin:0}
    .controls{display:flex;gap:8px;align-items:center}
    button{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    button.secondary{background:#666}
    .scoreboard{display:flex;gap:10px;align-items:center}
    .score{background:#fff;padding:8px 10px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.08)}
   .main{display:flex;gap:20px;flex-wrap:wrap}
    .board-wrap{background:transparent;padding:10px;border-radius:12px}
    .board{width:var(--board-size);height:var(--board-size);display:grid;grid-template-columns:repeat(4,1fr);grid-template-rows:repeat(4,1fr);gap:12px;padding:12px;background:rgba(0,0,0,0.05);border-radius:8px;position:relative}
    .cell{background:var(--tile-bg);border-radius:6px;display:flex;align-items:center;justify-content:center;font-weight:700;color:#776e65;font-size:22px}
    .tile{position:absolute;display:flex;align-items:center;justify-content:center;border-radius:6px;font-weight:800;transition:transform 160ms ease, top 160ms ease, left 160ms ease, opacity 160ms ease;min-width:calc((var(--board-size) - 12px*5)/4);min-height:calc((var(--board-size) - 12px*5)/4);}
    .tile .value{transform:translateZ(0)}
             .tile.v2{background:#eee4da;color:#776e65}
    .tile.v4{background:#ede0c8;color:#776e65}
    .tile.v8{background:#f2b179;color:#fff}
    .tile.v16{background:#f59563;color:#fff}
    .tile.v32{background:#f67c5f;color:#fff}
    .tile.v64{background:#f65e3b;color:#fff}
    .tile.v128{background:#edcf72;color:#fff;font-size:18px}
    .tile.v256{background:#edcc61;color:#fff;font-size:18px}
    .tile.v512{background:#edc850;color:#fff;font-size:16px}
    .tile.v1024{background:#edc53f;color:#fff;font-size:14px}
    .tile.v2048{background:#3c3bd3;color:#fff;font-size:14px}
    .tile.big{transform:scale(1.08)}
    .panel{flex:1;min-width:220px}
    .panel .info{background:#fff;padding:12px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.06)}
    .panel .actions{margin-top:12px;display:flex;gap:8px}
    .mobile-controls{display:none;margin-top:14px;gap:8px;justify-content:center}
    .mobile-controls button{padding:12px;border-radius:8px;min-width:52px}
    .modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;padding:20px}
    .modal{background:#fff;padding:16px;border-radius:10px;max-width:520px;width:100%}
    .hidden{display:none}
    .row{display:flex;gap:8px;align-items:center}
    input[type=text]{padding:8px;border-radius:6px;border:1px solid #ddd;flex:1}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
       @media (max-width:720px){
      .main{flex-direction:column;align-items:center}
      .panel{width:100%}
      .mobile-controls{display:flex}
      button{padding:10px 12px}
    }
  </style>
  </head>
<body>
    <div class="app">
    <header>
      <h1>2048 — Lab</h1>
      <div class="controls">
        <div class="scoreboard">
          <div class="score">Счёт: <span id="score">0</span></div>
          <div class="score">Лучший: <span id="best">0</span></div>
        </div>
        <div style="width:12px"></div>
        <div class="actions">
          <button id="undoBtn" class="secondary">Undo</button>
          <button id="restartBtn">Restart</button>
          <button id="leaderBtn" class="secondary">Leaderboards</button>
        </div>
      </div>
    </header>
   <div class="main">
       <div class="board-wrap">
        <div id="board" class="board"></div>
         </div>
        <div class="panel">
        <div class="info">
          <p>Управление: стрелки (desktop), свайпы или кнопки (мобилка)</p>
          <p>Функции: undo (отмена одного хода), сохранение состояния автоматически, лидерборд сохраняется в localStorage</p>
        </div>

        <div class="mobile-controls" id="mobileControls">
          <button data-dir="up">▲</button>
          <div style="display:flex;flex-direction:column;gap:8px">
            <button data-dir="left">◀</button>
            <button data-dir="down">▼</button>
            <button data-dir="right">▶</button>
          </div>
        </div>
      </div>
    </div>
          <div class="modal-back" id="modalBack">
      <div class="modal" id="modal">
        <div id="modalContent">
          <h3 id="modalTitle">Game over</h3>
          <p id="modalMsg">Введите имя чтобы сохранить рекорд</p>
          <div class="row" id="saveRow">
            <input id="playerName" type="text" placeholder="Ваше имя" />
            <button id="saveScoreBtn">Сохранить</button>
          </div>
          <div id="savedMsg" class="hidden">Ваш рекорд сохранён.</div>
          <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
            <button id="modalRestart">Начать заново</button>
            <button id="modalClose" class="secondary">Закрыть</button>
          </div>
        </div>
      </div>
    </div>
          <div class="modal-back" id="leaderBack">
      <div class="modal">
        <h3>Топ рекордов</h3>
        <table id="leaderTable">
          <thead><tr><th>Имя</th><th>Очки</th><th>Дата</th></tr></thead>
          <tbody></tbody>
        </table>
        <div style="margin-top:12px;text-align:right">
          <button id="clearLeaders" class="secondary">Очистить</button>
          <button id="closeLeaders">Закрыть</button>
        </div>
      </div>
    </div>
  </div>

    <script>
      
    const SIZE = 4;
    let grid = createEmpty();
    let score = 0;
    let best = Number(localStorage.getItem('2048_best')||0);
    let prevState = null; 
    let gameOver = false;

    const boardEl = document.getElementById('board');
    const scoreEl = document.getElementById('score');
    const bestEl = document.getElementById('best');
    const modalBack = document.getElementById('modalBack');
    const leaderBack = document.getElementById('leaderBack');

    bestEl.textContent = best;

 
    function createEmpty(){
      return Array.from({length:SIZE},()=>Array(SIZE).fill(0));
    }

    function saveGame(){
      localStorage.setItem('2048_state', JSON.stringify({grid,score,gameOver}));
      localStorage.setItem('2048_best', String(best));
    }

    function loadGame(){
      const s = localStorage.getItem('2048_state');
      if(!s) return false;
      try{
        const o = JSON.parse(s);
        grid = o.grid;
        score = o.score||0;
        gameOver = !!o.gameOver;
        return true;
      }catch(e){return false}
    }

    function clearBoardDOM(){ boardEl.innerHTML=''; }

    function drawBoard(){
      clearBoardDOM();
    
      for(let r=0;r<SIZE;r++){
        for(let c=0;c<SIZE;c++){
          const cell = document.createElement('div');
          cell.className='cell';
          boardEl.appendChild(cell);
        }
      }
      for(let r=0;r<SIZE;r++){
        for(let c=0;c<SIZE;c++){
          const v = grid[r][c];
          if(v>0){
            const tile = document.createElement('div');
            tile.className='tile v'+v;
            tile.style.top = `calc(${r} * ( (var(--board-size) - 12px*5)/4 + 12px) + 12px)`; 
            tile.style.left = `calc(${c} * ( (var(--board-size) - 12px*5)/4 + 12px) + 12px)`;
            tile.innerHTML = `<div class="value">${v}</div>`;
            tile.style.transform = 'translateZ(0)';
            tile.classList.add('big');
            boardEl.appendChild(tile);

            setTimeout(()=>tile.classList.remove('big'),160);
          }
        }
      }
      scoreEl.textContent = score;
      bestEl.textContent = best;
    }

    
    function addRandomTiles(count){
      const empties = [];
      for(let r=0;r<SIZE;r++) for(let c=0;c<SIZE;c++) if(grid[r][c]===0) empties.push([r,c]);
      if(empties.length===0) return;
      count = Math.min(count,empties.length);
      for(let i=0;i<count;i++){
        const idx = Math.floor(Math.random()*empties.length);
        const [r,c] = empties.splice(idx,1)[0];
        grid[r][c] = Math.random()<0.9?2:4;
      }
    }


    function cloneGrid(g){ return g.map(row=>row.slice()); }

    function compress(row){
      const out = row.filter(v=>v!==0);
      while(out.length< SIZE) out.push(0);
      return out;
    }

    function mergeRow(row){
      let points = 0;
      for(let i=0;i<SIZE-1;i++){
        if(row[i]!==0 && row[i]===row[i+1]){
          row[i] *=2;
          points += row[i];
          row[i+1]=0;
        }
      }
      return {row,points};
    }

    function moveLeft(){
      if(gameOver) return false;
      const before = cloneGrid(grid);
      let gained = 0;
      for(let r=0;r<SIZE;r++){
        let row = grid[r].slice();
        row = compress(row);
        const res = mergeRow(row);
        row = res.row;
        gained += res.points;
        row = compress(row);
        grid[r] = row;
      }
      if(!sameGrid(before,grid)){
        score += gained;
        if(score>best) best=score;
        prevState = {grid:before,score:score-gained}; 
        addRandomTiles(Math.random()<0.5?1:2);
        if(!canMove()) gameOverNow();
        saveGame();
        drawBoard();
        return true;
      }
      return false;
    }
          function rotateGridClockwise(g){
      const out = createEmpty();
      for(let r=0;r<SIZE;r++) for(let c=0;c<SIZE;c++) out[c][SIZE-1-r] = g[r][c];
      return out;
    }
    function rotateGridCounter(g){
      const out = createEmpty();
      for(let r=0;r<SIZE;r++) for(let c=0;c<SIZE;c++) out[SIZE-1-c][r] = g[r][c];
      return out;
    }
      function move(direction){
    
      if(gameOver) return;
      let moved=false;
      if(direction==='left') moved = moveLeft();
      else if(direction==='right'){
        grid = grid.map(row=>row.slice().reverse());
        moved = moveLeft();
        grid = grid.map(row=>row.slice().reverse());
      } else if(direction==='up'){
        grid = rotateGridClockwise(grid);
        moved = moveLeft();
        grid = rotateGridCounter(grid);
      } else if(direction==='down'){
        grid = rotateGridCounter(grid);
        moved = moveLeft();
        grid = rotateGridClockwise(grid);
      }
      if(moved) drawBoard();
    }

    function sameGrid(a,b){
      for(let r=0;r<SIZE;r++) for(let c=0;c<SIZE;c++) if(a[r][c]!==b[r][c]) return false;
      return true;
    }

    function canMove(){

      for(let r=0;r<SIZE;r++) for(let c=0;c<SIZE;c++) if(grid[r][c]===0) return true;
    
      for(let r=0;r<SIZE;r++) for(let c=0;c<SIZE-1;c++) if(grid[r][c]===grid[r][c+1]) return true;
      for(let c=0;c<SIZE;c++) for(let r=0;r<SIZE-1;r++) if(grid[r][c]===grid[r+1][c]) return true;
      return false;
    }

    function gameOverNow(){
      gameOver = true;
      saveGame();
      showModal();
    }

  
    function startNew(){
      grid = createEmpty();
      score = 0;
      prevState = null;
      gameOver = false;
      const initial = Math.floor(Math.random()*3)+1; 
      addRandomTiles(initial);
      saveGame();
      drawBoard();
    }

    document.getElementById('restartBtn').addEventListener('click',()=>{ startNew(); closeModal(); });
    document.getElementById('undoBtn').addEventListener('click',()=>{
      if(prevState && !gameOver){
        grid = cloneGrid(prevState.grid);
        score = prevState.score;
        prevState = null;
        drawBoard();
        saveGame();
      }
    });


    function showModal(){
      modalBack.style.display='flex';
      document.getElementById('playerName').value='';
      document.getElementById('savedMsg').classList.add('hidden');
      document.getElementById('saveRow').classList.remove('hidden');
      document.getElementById('modalTitle').textContent='Игра окончена';
      document.getElementById('modalMsg').textContent=`Ваш счёт: ${score}`;
    
      document.getElementById('mobileControls').style.display='none';
    }
    function closeModal(){ modalBack.style.display='none'; document.getElementById('mobileControls').style.display='flex'; }

    document.getElementById('modalClose').addEventListener('click',closeModal);
    document.getElementById('modalRestart').addEventListener('click',()=>{ startNew(); closeModal(); });

    document.getElementById('saveScoreBtn').addEventListener('click',()=>{
      const name = document.getElementById('playerName').value.trim() || 'Аноним';
      saveLeader(name, score);
      document.getElementById('saveRow').classList.add('hidden');
      document.getElementById('savedMsg').classList.remove('hidden');
    });


    function getLeaders(){
      return JSON.parse(localStorage.getItem('2048_leaders')||'[]');
    }
    function saveLeader(name, pts){
      const list = getLeaders();
      list.push({name,pts,date:(new Date()).toLocaleString()});
      list.sort((a,b)=>b.pts - a.pts);
      while(list.length>10) list.pop();
      localStorage.setItem('2048_leaders', JSON.stringify(list));
      renderLeaders();
    }
    function renderLeaders(){
      const tbody = document.querySelector('#leaderTable tbody');
      tbody.innerHTML='';
      const list = getLeaders();
      for(const row of list){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(row.name)}</td><td>${row.pts}</td><td>${row.date}</td>`;
        tbody.appendChild(tr);
      }
    }
    document.getElementById('leaderBtn').addEventListener('click',()=>{ leaderBack.style.display='flex'; document.getElementById('mobileControls').style.display='none'; renderLeaders(); });
    document.getElementById('closeLeaders').addEventListener('click',()=>{ leaderBack.style.display='none'; document.getElementById('mobileControls').style.display='flex'; });
    document.getElementById('clearLeaders').addEventListener('click',()=>{ localStorage.removeItem('2048_leaders'); renderLeaders(); });

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

    window.addEventListener('keydown',(e)=>{
      if(e.key.includes('Arrow')){
        e.preventDefault();
        if(e.key==='ArrowUp') move('up');
        if(e.key==='ArrowDown') move('down');
        if(e.key==='ArrowLeft') move('left');
        if(e.key==='ArrowRight') move('right');
      }
    });


    document.getElementById('mobileControls').addEventListener('click',(e)=>{
      const b = e.target.closest('button'); if(!b) return;
      const dir = b.dataset.dir; if(!dir) return;
      move(dir);
    });


    (function addSwipe(){
      let startX=0,startY=0;
      boardEl.addEventListener('touchstart',e=>{
        startX = e.changedTouches[0].clientX; startY = e.changedTouches[0].clientY;
      },{passive:true});
      boardEl.addEventListener('touchend',e=>{
        const dx = e.changedTouches[0].clientX - startX;
        const dy = e.changedTouches[0].clientY - startY;
        if(Math.abs(dx) < 30 && Math.abs(dy) < 30) return;
        if(Math.abs(dx) > Math.abs(dy)) move(dx>0? 'right':'left');
        else move(dy>0? 'down':'up');
      });
    })();


    function init(){
      boardEl.style.setProperty('--board-size', getComputedStyle(document.documentElement).getPropertyValue('--board-size'));
      if(!loadGame()) startNew();
      drawBoard();
      renderLeaders();

      if(window.innerWidth<=720) document.getElementById('mobileControls').style.display = gameOver? 'none':'flex';
    }

   
    window.addEventListener('beforeunload',()=>saveGame());

    init();
    </script>
        </body>
</html>
